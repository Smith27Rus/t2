<?php
/**
 * Telegram-Ğ±Ğ¾Ñ‚ Â«ĞšĞ»ĞµĞ²ĞµÑ€Â» Ğ´Ğ»Ñ klever27.ru
 * Ğ¤Ğ¸ĞºÑÑ‹: Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ ACK Ğ´Ğ»Ñ Ğ²ÑĞµÑ… callback, Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€ Â«Ğ¿Ğ¾ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚ÑƒÂ»,
 * Ñ€ÑƒÑÑĞºĞ°Ñ ÑĞ¿Ñ€Ğ°Ğ²ĞºĞ°, ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ°Ñ‚ Ğ´Ğ´.Ğ¼Ğ¼.Ğ³Ğ³Ğ³Ğ³, Ğ²ĞµÑ€Ñ‚Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€ ĞºĞ»Ğ¸Ğ½Ğ¸ĞºĞ¸,
 * Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ Ğ² Ñ‚Ğ¾Ğ¼ Ğ¶Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¸ (Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµÑ‚ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½Ğ½Ñ‹Ğ¹ Calendar.php),
 * Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ² /bot/data/error.log, /start Ğ² ĞºĞ¾Ğ½Ñ†Ğµ ÑĞ¿Ğ¸ÑĞºĞ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´.
 * Ğ”Ğ¾Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸: ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚-ÑˆÑÑ€ Ğ±ĞµĞ· Â«ÑĞ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ĞºĞ»Ğ¸Ğ½Ğ¸ĞºÑƒÂ», 12 Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¹/ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°, 1 ĞºĞ½Ğ¾Ğ¿ĞºĞ° Ğ² ÑÑ‚Ñ€Ğ¾ĞºĞµ,
 * Â«Ğ²Ñ€Ğ°Ñ‡Â» â†’ Â«ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚Â», ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ ÑˆĞ°Ğ³Ğ° Ñ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ¹ ĞºĞ»Ğ¸Ğ½Ğ¸ĞºĞ¾Ğ¹ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ²,
 * Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¿Ğ¸ÑĞºĞ° Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹/ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚Ğ¾Ğ² Ğ² Ñ‚Ğ¾Ğ¼ Ğ¶Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¸,
 * Ğ¨Ğ°Ğ³ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ° ÑĞ²ÑĞ·Ğ¸ (Ğ¿ĞµÑ€ĞµĞ·Ğ²Ğ¾Ğ½Ğ¸Ñ‚ÑŒ/WhatsApp/Telegram) Ğ¿ĞµÑ€ĞµĞ´ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸ĞµĞ¼.
 *
 * Ğ”Ğ¾Ğ¿. Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ² ÑÑ‚Ğ¾Ğ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸:
 * - ĞŸĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ğ°Ñ Ñ€ĞµĞ¿Ğ»Ğ°Ğ¹-ĞºĞ»Ğ°Ğ²Ğ° 2Ã—2, ÑĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ½Ğ° ÑˆĞ°Ğ³Ğµ request_contact.
 * - ĞšĞ½Ğ¾Ğ¿ĞºĞ° Â«ğŸ¥ Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ´Ñ€ÑƒĞ³ÑƒÑ ĞºĞ»Ğ¸Ğ½Ğ¸ĞºÑƒÂ» Ğ¿ĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ° Ğ² Â«ğŸ”„ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ĞºĞ»Ğ¸Ğ½Ğ¸ĞºÑƒÂ».
 */

declare(strict_types=1);
mb_internal_encoding('UTF-8');
mb_language('uni');
date_default_timezone_set('Asia/Vladivostok');

const BOT_TOKEN    = '7971315021:AAEMCa6GGFThXVn3cqR4H43M48yg5InSCNY';
const API          = 'https://api.telegram.org/bot'.BOT_TOKEN.'/';
const FILE_API     = 'https://api.telegram.org/file/bot'.BOT_TOKEN.'/';
const ADMIN_CHAT   = -1003119914761;

const DATA_DIR     = __DIR__ . '/data';
const MOD_DIR      = __DIR__ . '/modules';
const REF_DIR      = __DIR__ . '/ref';

const EMAIL_FROM   = 'noreply@klever27.ru';
const EMAIL_TO     = 'destroyer@a-smith.ru';

const PAGE_SIZE    = 12; // Ğ±Ñ‹Ğ»Ğ¾ 16 â€” Ñ‚ĞµĞ¿ĞµÑ€ÑŒ 12, ĞºĞ°Ğº Ğ¿Ñ€Ğ¾ÑĞ¸Ğ»Ğ¸

@is_dir(DATA_DIR) || @mkdir(DATA_DIR, 0775, true);

/* ====== Ğ»Ğ¾Ğ³ ====== */
function elog(string $s): void {
    @file_put_contents(DATA_DIR.'/error.log', '['.date('Y-m-d H:i:s')."] ".$s."\n", FILE_APPEND);
}
set_error_handler(function($no,$str,$file,$line){
    elog("PHP[$no] $str @ $file:$line");
});
register_shutdown_function(function(){
    $e = error_get_last();
    if ($e && in_array($e['type'], [E_ERROR,E_PARSE,E_CORE_ERROR,E_COMPILE_ERROR,E_USER_ERROR], true)) {
        elog("FATAL: {$e['message']} @ {$e['file']}:{$e['line']}");
    }
});

require_once MOD_DIR.'/Calendar.php';

/* ====== helpers ====== */
function tg(string $method, array $params = []): array {
    $ch = curl_init(API.$method);
    curl_setopt_array($ch, [
        CURLOPT_RETURNTRANSFER=>true,
        CURLOPT_POST=>true,
        CURLOPT_POSTFIELDS=>$params, // <-- Ğ‘Ğ«Ğ›Ğ ĞĞ¨Ğ˜Ğ‘ĞšĞ: Ğ½Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ² ĞºĞ°Ğ²Ñ‹Ñ‡ĞºĞ°Ñ…
        CURLOPT_CONNECTTIMEOUT=>6,
        CURLOPT_TIMEOUT=>12,
    ]);
    $out = curl_exec($ch);
    if ($out === false) { elog("cURL ".curl_errno($ch).": ".curl_error($ch)." in $method"); }
    curl_close($ch);
    $j = json_decode((string)$out, true);
    if (!is_array($j) || !isset($j['ok'])) { elog("Bad TG response in $method: ".substr((string)$out,0,200)); }
    return is_array($j)?$j:['ok'=>false,'result'=>null];
}
function sendMessage(int|string $chatId, string $text, array $extra=[]): void {
    $p = array_merge(['chat_id'=>$chatId,'text'=>$text,'parse_mode'=>'HTML','disable_web_page_preview'=>true], $extra);
    tg('sendMessage', $p);
}
function editMessageReplyMarkup(int|string $chatId, int $messageId, string $markup): void {
    tg('editMessageReplyMarkup', ['chat_id'=>$chatId, 'message_id'=>$messageId, 'reply_markup'=>$markup]);
}
function editMessageText(int|string $chatId, int $messageId, string $text, string $markup=''): void {
    $params = ['chat_id'=>$chatId,'message_id'=>$messageId,'text'=>$text,'parse_mode'=>'HTML','disable_web_page_preview'=>true];
    if ($markup !== '') $params['reply_markup'] = $markup;
    tg('editMessageText', $params);
}
function getFileLink(string $fileId): ?string {
    $r = tg('getFile', ['file_id'=>$fileId]);
    if (!($r['ok']??false)) return null;
    $path = $r['result']['file_path']??null;
    return $path ? FILE_API.$path : null;
}
function inlineButtons(array $rows): string { return json_encode(['inline_keyboard'=>$rows], JSON_UNESCAPED_UNICODE); }
function kb_back_cancel(string $flow, string $where=''): string {
    $back = 'back:'.$flow.($where!==''?':'.$where:'');
    return inlineButtons([[['text'=>'â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´','callback_data'=>$back],['text'=>'âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°','callback_data'=>'cancel']]]);
}
function ack(string $cbId, string $text = '', int $cache = 0): void {
    tg('answerCallbackQuery', ['callback_query_id'=>$cbId, 'text'=>$text, 'cache_time'=>$cache]);
}

/* ====== email helper (Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Â«Ğ°Ğ±Ñ€Ğ°ĞºĞ°Ğ´Ğ°Ğ±Ñ€ÑƒÂ») ====== */
/* ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ HTML Ğ² base64 Ñ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¼Ğ¸ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°Ğ¼Ğ¸ (RFC 2047/2045), CRLF, Date/Message-ID â€” Ğ´Ñ€ÑƒĞ¶ĞµĞ»ÑĞ±Ğ½Ğ¾ Ğº Outlook. */
function sendHtmlMail(string $to, string $subject, string $html): void {
    $encSubject = mb_encode_mimeheader($subject, 'UTF-8', 'B', "\r\n");
    $fromName   = mb_encode_mimeheader('ĞšĞ»ĞµĞ²ĞµÑ€', 'UTF-8', 'B', "\r\n") . ' <'.EMAIL_FROM.'>';

    // Ğ¢ĞµĞ»Ğ¾ Ğ¿Ğ¸ÑÑŒĞ¼Ğ° Ğ² base64, Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑÑ‹ 76 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ² + CRLF
    $body = chunk_split(base64_encode($html), 76, "\r\n");

    // Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸
    $headers = [
        'From: '.$fromName,
        'Reply-To: '.EMAIL_FROM,
        'MIME-Version: 1.0',
        'Date: '.date('r'),
        'Message-ID: <'.bin2hex(random_bytes(8)).'@klever27.ru>',
        'X-Mailer: PHP/'.PHP_VERSION,
        'Content-Type: text/html; charset=UTF-8',
        'Content-Transfer-Encoding: base64',
    ];

    // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹ mail() â€” Ğ¾Ğ½ Ğ½Ğ°Ğ´Ñ‘Ğ¶Ğ½ĞµĞµ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ² Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… ÑÑ‚ÑĞºĞ°Ñ… MTA
    @mail($to, $encSubject, $body, implode("\r\n", $headers));
}

/* ====== state ====== */
function statePath(int $uid): string { return DATA_DIR.'/u_'.$uid.'.json'; }
function loadState(int $uid): array {
    $p = statePath($uid);
    if (!is_file($p)) return ['step'=>null,'flow'=>null,'clinic'=>null,'data'=>[],'files'=>[]];
    $j = json_decode((string)@file_get_contents($p), true);
    return is_array($j)?$j:['step'=>null,'flow'=>null,'clinic'=>null,'data'=>[],'files'=>[]];
}
function saveState(int $uid, array $st): void { @file_put_contents(statePath($uid), json_encode($st, JSON_UNESCAPED_UNICODE)); }
function fullReset(int $uid): array { $st=['step'=>null,'flow'=>null,'clinic'=>null,'data'=>[],'files'=>[]]; saveState($uid,$st); return $st; }
function resetFlow(int $uid, array &$st): void {
    $clinic = $st['clinic'] ?? null;
    $st = ['step'=>null,'flow'=>null,'clinic'=>$clinic,'data'=>[],'files'=>[]];
    saveState($uid,$st);
}

/* ====== commands ====== */
function setCommands(): void {
    $cmds = [
        ['command'=>'appointment','description'=>'Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ‘Ğ¼'],
        ['command'=>'deduction','description'=>'ĞĞ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ Ğ²Ñ‹Ñ‡ĞµÑ‚'],
        ['command'=>'feedback','description'=>'ĞÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚Ğ·Ñ‹Ğ²'],
        ['command'=>'complaint','description'=>'Ğ–Ğ°Ğ»Ğ¾Ğ±Ğ° Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»Ñ'],
        ['command'=>'start','description'=>'ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ°'], // Ğ² ĞºĞ¾Ğ½Ñ†Ğµ
    ];
    tg('setMyCommands', ['commands'=>json_encode($cmds, JSON_UNESCAPED_UNICODE)]);
    tg('setChatMenuButton', ['menu_button'=>json_encode(['type'=>'commands'])]);
}
function ensureCommandsInit(): void { static $once=null; if($once===null){ setCommands(); $once=true; } }

/* ====== ÑĞ¿Ñ€Ğ°Ğ²Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¸ ====== */
function clinics(): array { return require REF_DIR.'/clinics.php'; }
function servicesByClinic(string $key): array { return $key==='neuro' ? require REF_DIR.'/services_neuro.php' : require REF_DIR.'/services_speech.php'; }
function doctorsByClinic(string $key): array { return $key==='neuro' ? require REF_DIR.'/doctors_neuro.php' : require REF_DIR__.'/doctors_speech.php'; }
function contactsByClinic(string $key): array { return require REF_DIR.'/contacts.php'; }

/* ====== Ğ´Ğ°Ñ‚Ñ‹ ====== */
function fmtDmy(string $iso): string {
    if(!preg_match('~^\d{4}-\d{2}-\d{2}$~',$iso)) return $iso;
    [$y,$m,$d]=explode('-',$iso); return $d.'.'.$m.'.'.$y;
}
function parseDmyToIso(string $dmy): ?string {
    if(!preg_match('~^(\d{2})\.(\d{2})\.(\d{4})$~',trim($dmy),$m)) return null;
    [$a,$d,$mm,$y]=$m; if(!checkdate((int)$mm,(int)$d,(int)$y)) return null;
    return sprintf('%04d-%02d-%02d',(int)$y,(int)$mm,(int)$d);
}

/* ====== Ñ€ĞµĞ¿Ğ»Ğ°Ğ¹-ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñ‹ ====== */
function mainReplyKeyboard(): array {
    return [
        [['text'=>'ğŸ—“ Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ‘Ğ¼'], ['text'=>'ğŸ“ ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹']],
        [['text'=>'ğŸ”„ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ĞºĞ»Ğ¸Ğ½Ğ¸ĞºÑƒ'], ['text'=>'â„¹ï¸ Ğ¡Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¿Ğ¾ Ğ±Ğ¾Ñ‚Ñƒ']],
    ];
}
function sendKeyboardMain(int|string $chatId, string $clinicLabel): void {
    tg('sendMessage', [
        'chat_id'=>$chatId,
        'text'=>"Ğ’Ñ‹ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ»Ğ¸: <b>{$clinicLabel}</b>\nĞ§Ñ‚Ğ¾ Ğ²Ğ°Ñ Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑÑƒĞµÑ‚?",
        'parse_mode'=>'HTML',
        'reply_markup'=>json_encode(['keyboard'=>mainReplyKeyboard(),'resize_keyboard'=>true,'is_persistent'=>true])
    ]);
}
function restoreMainKeyboard(int|string $chatId): void {
    // Ğ¡ĞµÑ€Ğ²Ğ¸ÑĞ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ğ¾Ğ¹ 2Ã—2 ĞºĞ»Ğ°Ğ²Ñ‹
    tg('sendMessage', [
        'chat_id'=>$chatId,
        'text'=>' ',
        'reply_markup'=>json_encode(['keyboard'=>mainReplyKeyboard(),'resize_keyboard'=>true,'is_persistent'=>true])
    ]);
}

/* ====== Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸ / Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸ ====== */
function clinicSelectKeyboard(): string {
    $cl = clinics();
    return inlineButtons([
        [ ['text'=>$cl['neuro']['title'],  'callback_data'=>'clinic:neuro'] ],
        [ ['text'=>$cl['speech']['title'], 'callback_data'=>'clinic:speech'] ],
    ]);
}
function askClinic(int $chatId): void {
    $text = "ğŸ‘‹ Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² Ñ‡Ğ°Ñ‚-Ğ±Ğ¾Ñ‚ Â«ĞšĞ»ĞµĞ²ĞµÑ€Â»!\n\nğŸ¥ ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ĞºĞ»Ğ¸Ğ½Ğ¸ĞºÑƒ:";
    tg('sendMessage', ['chat_id'=>$chatId,'text'=>$text,'reply_markup'=>clinicSelectKeyboard()]);
}
function formatContacts(array $c): string {
    $t="ğŸ“ ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ â€” <b>{$c['title']}</b>\n";
    $t.="ğŸ“ ĞĞ´Ñ€ĞµÑ: {$c['address']}\n";
    $t.="â˜ï¸ Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½: <a href=\"tel:".preg_replace('~\D+~','',$c['phone'])."\">{$c['phone']}</a>\n";
    if(!empty($c['whatsapp']))$t.="ğŸ’¬ WhatsApp: <a href=\"https://wa.me/".preg_replace('~\D+~','',$c['whatsapp'])."\">{$c['whatsapp']}</a>\n";
    if(!empty($c['email']))$t.="âœ‰ï¸ ĞŸĞ¾Ñ‡Ñ‚Ğ°: <a href=\"mailto:{$c['email']}\">{$c['email']}</a>\n";
    if(!empty($c['site']))$t.="ğŸŒ Ğ¡Ğ°Ğ¹Ñ‚: <a href=\"{$c['site']}\">{$c['site']}</a>\n";
    $t.="ğŸ•˜ Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº: {$c['hours']}"; return $t;
}

/* Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸ ÑˆĞ°Ğ³Ğ¾Ğ² Ñ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ¹ ĞºĞ»Ğ¸Ğ½Ğ¸ĞºĞ¾Ğ¹ */
function headerAppointment(array $st): string {
    $cl = clinics(); $ct = $cl[$st['clinic']]['title'] ?? '';
    return "ğŸ—“ <b>Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ‘Ğ¼:</b> {$ct}\n\n";
}
function headerDeduction(array $st): string {
    $cl = clinics(); $ct = $cl[$st['clinic']]['title'] ?? '';
    return "ğŸ’° <b>ĞĞ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ Ğ²Ñ‹Ñ‡ĞµÑ‚:</b> {$ct}\n\n";
}
function headerComplaint(array $st): string {
    $cl = clinics(); $ct = $cl[$st['clinic']]['title'] ?? '';
    return "âš ï¸ <b>Ğ–Ğ°Ğ»Ğ¾Ğ±Ğ° Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»Ñ:</b> {$ct}\n\n";
}

/* ====== Ñ€ĞµĞ·ÑĞ¼Ğµ ====== */
function userLink(array $from): string {
    $id=(int)($from['id']??0); $name=trim(($from['first_name']??'').' '.($from['last_name']??''))?:'ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ';
    $u=$from['username']??null; $link=$u?'https://t.me/'.$u:'tg://user?id='.$id;
    return '<a href="'.$link.'">'.htmlspecialchars($name).'</a>'.($u?' (@'.htmlspecialchars($u).')':'');
}
function summarizeAppointment(string $clinicTitle,array $d,bool $forAdmin=false,string $sender=''):string{
    $date=isset($d['date'])?fmtDmy($d['date']):'';
    $txt="ğŸ“‹ <b>Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ â€” {$clinicTitle}</b>\n".
         "ğŸ‘¤ Ğ˜Ğ¼Ñ: ".htmlspecialchars($d['name'])."\n".
         "ğŸ“ Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½: ".htmlspecialchars($d['phone'])."\n".
         "ğŸ· Ğ¡Ğ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚/Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: ".htmlspecialchars($d['item'])."\n".
         "ğŸ“… Ğ”Ğ°Ñ‚Ğ°: ".htmlspecialchars($date)."\n".
         "ğŸ’¬ ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹: ".htmlspecialchars($d['comment']??'â€”')."\n".
         "ğŸ”” Ğ¡Ğ¿Ğ¾ÑĞ¾Ğ± ÑĞ²ÑĞ·Ğ¸: ".htmlspecialchars($d['contact_method']??'â€”');
    if($forAdmin)$txt.="\nğŸ‘¥ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒ: {$sender}\nğŸ”— ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ¸Ğ· Ğ±Ğ¾Ñ‚Ğ°";
    return $txt;
}
function summarizeDeduction(string $clinicTitle,array $d,bool $forAdmin=false,string $sender=''):string{
    $txt="ğŸ’° <b>ĞĞ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ Ğ²Ñ‹Ñ‡ĞµÑ‚ â€” {$clinicTitle}</b>\n".
        "ğŸ‘¤ Ğ˜Ğ¼Ñ: ".htmlspecialchars($d['name'])."\n".
        "ğŸ“ Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½: ".htmlspecialchars($d['phone'])."\n".
        "âœ‰ï¸ Email: ".htmlspecialchars($d['email']);
    if($forAdmin)$txt.="\nğŸ‘¥ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒ: {$sender}\nğŸ”— ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ¸Ğ· Ğ±Ğ¾Ñ‚Ğ°";
    return $txt;
}
function summarizeComplaint(string $clinicTitle,array $d,array $files,bool $forAdmin=false,string $sender=''):string{
    $date=isset($d['visit_date'])?fmtDmy($d['visit_date']):'';
    $t="âš ï¸ <b>Ğ–Ğ°Ğ»Ğ¾Ğ±Ğ° Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»Ñ â€” {$clinicTitle}</b>\n".
       "ğŸ‘¤ Ğ˜Ğ¼Ñ: ".htmlspecialchars($d['name'])."\n".
       "ğŸ“ Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½: ".htmlspecialchars($d['phone'])."\n".
       "ğŸ“… Ğ”Ğ°Ñ‚Ğ° Ğ²Ğ¸Ğ·Ğ¸Ñ‚Ğ°: ".htmlspecialchars($date)."\n".
       "ğŸ’¬ ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹: ".htmlspecialchars($d['comment']??'â€”')."\n";
    if($files){ $t.="ğŸ“ Ğ’Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ:\n"; foreach($files as $f){ $link=$f['link']??''; $t.="â€¢ ".strtoupper($f['type'])." â€” ".($link?"<a href=\"{$link}\">ÑÑÑ‹Ğ»ĞºĞ°</a>":"â€”")."\n"; } }
    if($forAdmin)$t.="ğŸ‘¥ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒ: {$sender}\nğŸ”— ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ¸Ğ· Ğ±Ğ¾Ñ‚Ğ°";
    return rtrim($t);
}

/* ====== Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¹/ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚Ğ¾Ğ² ====== */
function buildPagedList(array $list, int $page, string $mode): array {
    $total = count($list);
    $pages = max(1, (int)ceil(max(1,$total)/PAGE_SIZE));
    $page  = max(0, min($pages-1, $page));
    $slice = array_slice($list, $page*PAGE_SIZE, PAGE_SIZE);

    $rows=[];
    foreach($slice as $it){
        // Ğ¾Ğ´Ğ½Ğ° ĞºĞ½Ğ¾Ğ¿ĞºĞ° Ğ² ÑÑ‚Ñ€Ğ¾ĞºĞµ
        $rows[] = [ ['text'=>$it,'callback_data'=>'item:'.substr(md5($it),0,10)] ];
    }
    if($pages>1){
        $rows[] = [
            ['text'=>'â—€ï¸','callback_data'=>'apptpage:'.$mode.':'.max(0,$page-1)],
            ['text'=>'Ğ¡Ñ‚Ñ€. '.($page+1).'/'.$pages,'callback_data'=>'noop'],
            ['text'=>'â–¶ï¸','callback_data'=>'apptpage:'.$mode.':'.min($pages-1,$page+1)],
        ];
    }
    $rows[]=[['text'=>'â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´','callback_data'=>'back:appointment:choose_mode'],['text'=>'âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°','callback_data'=>'cancel']];
    return [$rows,$page,$pages];
}

/* ====== Ğ²Ñ…Ğ¾Ğ´ ====== */
$update = json_decode(file_get_contents('php://input') ?: '[]', true);
if(!$update){ http_response_code(200); exit; }
ensureCommandsInit();

$cb  = $update['callback_query'] ?? null;
$msg = $update['message'] ?? null;

/* ====== CALLBACKS ====== */
if($cb){
    $cid = $cb['message']['chat']['id'];
    $uid = $cb['from']['id'];
    $fromU = $cb['from'];
    $data = (string)($cb['data']??'');
    $st = loadState($uid);
    $cl = clinics();

    // Ğ¼Ğ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ½Ğ¾ Ğ³Ğ°ÑĞ¸Ğ¼ Â«ÑĞ¿Ğ¸Ğ½Ğ½ĞµÑ€Â»
    ack($cb['id']);

    try {

        /* ĞÑ‚Ğ¼ĞµĞ½Ğ° */
        if($data==='cancel'){
            resetFlow($uid,$st);
            $label = $st['clinic']&&isset($cl[$st['clinic']])?$cl[$st['clinic']]['title']:'â€”';
            sendKeyboardMain($cid,$label);
            exit;
        }

        /* Ğ’Ñ‹Ğ±Ğ¾Ñ€ ĞºĞ»Ğ¸Ğ½Ğ¸ĞºĞ¸ */
        if(str_starts_with($data,'clinic:')){
            $key = explode(':',$data,2)[1]??'';
            if(!isset($cl[$key])){ askClinic($cid); exit; }
            $st = ['step'=>null,'flow'=>null,'clinic'=>$key,'data'=>[],'files'=>[]];
            saveState($uid,$st);
            sendKeyboardMain($cid,$cl[$key]['title']);
            exit;
        }

        /* Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ: ÑĞ¿Ğ¾ÑĞ¾Ğ± (Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ) */
        if(str_starts_with($data,'apptmode:')){
            $mode = explode(':',$data,2)[1]??'by_service';
            $list = $mode==='by_service' ? servicesByClinic($st['clinic']) : doctorsByClinic($st['clinic']);
            if (!is_array($list)) { throw new \RuntimeException('Ğ¡Ğ¿Ñ€Ğ°Ğ²Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ²ĞµÑ€Ğ½ÑƒĞ» Ğ½Ğµ Ğ¼Ğ°ÑÑĞ¸Ğ²'); }
            $map = [];
            foreach($list as $it){ $map[substr(md5($it),0,10)] = $it; }

            $st['flow']='appointment';
            $st['step']='choose_item';
            $st['data']=['mode'=>$mode,'page'=>0,'map'=>$map];
            saveState($uid,$st);

            $mid = (int)$cb['message']['message_id'];
            if(!$list){
                editMessageText($cid,$mid, headerAppointment($st).'Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿ÑƒÑÑ‚. Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ¹ ÑĞ¿Ğ¾ÑĞ¾Ğ± Ğ¸Ğ»Ğ¸ Ğ²ĞµÑ€Ğ½Ğ¸Ñ‚ĞµÑÑŒ Ğ½Ğ°Ğ·Ğ°Ğ´.',
                    inlineButtons([[['text'=>'â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´','callback_data'=>'back:appointment:choose_mode'],['text'=>'âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°','callback_data'=>'cancel']]]));
                exit;
            }
            [$rows] = buildPagedList($list,0,$mode);
            editMessageText(
                $cid,$mid,
                headerAppointment($st).($mode==='by_service'?'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ:':'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚Ğ°:'),
                inlineButtons($rows)
            );
            exit;
        }

        /* Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ: Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ (Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ) */
        if(str_starts_with($data,'apptpage:')){
            $p = explode(':',$data); // apptpage:mode:page
            $mode=$p[1]??'by_service'; $page=(int)($p[2]??0);
            $list = $mode==='by_service' ? servicesByClinic($st['clinic']) : doctorsByClinic($st['clinic']);
            if (!is_array($list)) { throw new \RuntimeException('Ğ¡Ğ¿Ñ€Ğ°Ğ²Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ²ĞµÑ€Ğ½ÑƒĞ» Ğ½Ğµ Ğ¼Ğ°ÑÑĞ¸Ğ²'); }
            [$rows,$page,$pages]=buildPagedList($list,$page,$mode);
            $mid = (int)$cb['message']['message_id'];
            editMessageText(
                $cid,$mid,
                headerAppointment($st).($mode==='by_service'?'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ:':'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚Ğ°:'),
                inlineButtons($rows)
            );
            exit;
        }

        /* Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ: Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚ */
        if(str_starts_with($data,'item:')){
            $code = explode(':',$data,2)[1]??'';
            $map = $st['data']['map'] ?? [];
            if(!isset($map[$code])){ sendMessage($cid,headerAppointment($st).'Ğ­Ğ»ĞµĞ¼ĞµĞ½Ñ‚ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ÑĞ½Ğ¾Ğ²Ğ°.'); exit; }
            $st['data']['item']=$map[$code];
            $st['step']='get_name';
            saveState($uid,$st);
            sendMessage($cid,headerAppointment($st)."Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°ÑˆĞµ Ğ¸Ğ¼Ñ:",['reply_markup'=>kb_back_cancel('appointment','get_name')]);
            exit;
        }

        /* ĞšĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ */
        if(str_starts_with($data,'cal:')){
            $parts = explode(':',$data);
            $cal = new \Klever\Calendar();
            $res = $cal->handleParts($parts);

            if(($parts[1] ?? '')==='pick' && $res['picked']){
                $st['data']['date']=$res['picked'];
                $st['step']='get_comment'; saveState($uid,$st);
                sendMessage($cid,headerAppointment($st)."Ğ’Ñ‹ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ»Ğ¸ Ğ´Ğ°Ñ‚Ñƒ: <b>".fmtDmy($res['picked'])."</b>\nĞ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹ (Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Â«-Â»):",
                    ['parse_mode'=>'HTML','reply_markup'=>kb_back_cancel('appointment','get_comment')]);
            } elseif ($res['markup'] ?? null) {
                // Ğ¿ĞµÑ€ĞµÑ€Ğ¸ÑÑƒĞµĞ¼ Ğ¡Ğ¢ĞĞ ĞĞ• ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ
                $mid = $cb['message']['message_id'];
                editMessageReplyMarkup($cid, $mid, $res['markup']);
            }
            exit;
        }

        /* Ğ’Ñ‹Ğ±Ğ¾Ñ€ ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ° ÑĞ²ÑĞ·Ğ¸ */
        if(str_starts_with($data,'contact_method:')){
            $val = explode(':',$data,2)[1]??'';
            $labels = [
                'call'     => 'ğŸ“ ĞŸĞµÑ€ĞµĞ·Ğ²Ğ¾Ğ½Ğ¸Ñ‚ÑŒ',
                'whatsapp' => 'ğŸ’¬ ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ² WhatsApp',
                'telegram' => 'ğŸ’¬ ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ² Telegram',
            ];
            $st['data']['contact_method'] = $labels[$val] ?? $val;
            $st['step']='confirm'; saveState($uid,$st);

            $clinicTitle=clinics()[$st['clinic']]['title'];
            $sumUser=summarizeAppointment($clinicTitle,$st['data'],false);
            $kb=[[['text'=>'â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´','callback_data'=>'back:appointment:get_contact_method'],['text'=>'âœ… ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ','callback_data'=>'confirm:appointment']],[['text'=>'âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°','callback_data'=>'cancel']]];
            sendMessage($cid,$sumUser,['reply_markup'=>inlineButtons($kb)]);
            exit;
        }

        /* ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ */
        if($data==='confirm:appointment'){
            $clinicTitle=clinics()[$st['clinic']]['title']; $sender=userLink($fromU);
            $txtAdmin=summarizeAppointment($clinicTitle,$st['data'],true,$sender);
            sendMessage(ADMIN_CHAT,$txtAdmin);
            sendMessage($cid,"âœ… Ğ—Ğ°ÑĞ²ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ°! Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾, Ğ¼Ñ‹ ÑĞ²ÑĞ¶ĞµĞ¼ÑÑ Ñ Ğ²Ğ°Ğ¼Ğ¸ Ğ² Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ.");
            resetFlow($uid,$st); exit;
        }
        if($data==='confirm:deduction'){
            $clinicTitle=clinics()[$st['clinic']]['title']; $sender=userLink($fromU);
            $txtAdmin=summarizeDeduction($clinicTitle,$st['data'],true,$sender);
            sendMessage(ADMIN_CHAT,$txtAdmin);
            sendHtmlMail(EMAIL_TO,'Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ²Ñ‹Ñ‡ĞµÑ‚Ğ°', nl2br($txtAdmin));
            sendMessage($cid,"âœ… Ğ—Ğ°ÑĞ²ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ°! Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾, Ğ¼Ñ‹ ÑĞ²ÑĞ¶ĞµĞ¼ÑÑ Ñ Ğ²Ğ°Ğ¼Ğ¸ Ğ² Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ.");
            resetFlow($uid,$st); exit;
        }
        if($data==='confirm:complaint'){
            $clinicTitle=clinics()[$st['clinic']]['title']; $sender=userLink($fromU);
            $txtAdmin=summarizeComplaint($clinicTitle,$st['data'],$st['files'],true,$sender);
            sendMessage(ADMIN_CHAT,$txtAdmin);
            sendHtmlMail(EMAIL_TO,'Ğ–Ğ°Ğ»Ğ¾Ğ±Ğ° Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»Ñ', nl2br($txtAdmin));
            sendMessage($cid,"âœ… Ğ–Ğ°Ğ»Ğ¾Ğ±Ğ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»Ñ. Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾, Ñ‡Ñ‚Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰Ğ¸Ğ»Ğ¸ Ğ¾ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğµ â€” Ğ¼Ñ‹ Ñ€Ğ°Ğ·Ğ±ĞµÑ€Ñ‘Ğ¼ÑÑ.");
            resetFlow($uid,$st); exit;
        }

        /* Ğ–Ğ°Ğ»Ğ¾Ğ±Ğ°: Ğ²ĞµÑ‚ĞºĞ° Ñ Ğ²Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ÑĞ¼Ğ¸ */
        if($data==='attach_yes'){
            $st['step']='attach_files'; saveState($uid,$st);
            sendMessage($cid,headerComplaint($st).'ĞŸÑ€Ğ¸ÑˆĞ»Ğ¸Ñ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾/Ğ²Ğ¸Ğ´ĞµĞ¾/Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹. ĞšĞ¾Ğ³Ğ´Ğ° Ğ±ÑƒĞ´ĞµÑ‚Ğµ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹ â€” Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Â«ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒÂ».',[
                'reply_markup'=>inlineButtons([[['text'=>'â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´','callback_data'=>'back:complaint:get_comment'],['text'=>'âœ… ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ','callback_data'=>'confirm:complaint']],[['text'=>'âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°','callback_data'=>'cancel']]])
            ]); exit;
        }
        if($data==='attach_no'){
            $st['step']='confirm'; saveState($uid,$st);
            $clinicTitle=clinics()[$st['clinic']]['title'];
            $sumUser=summarizeComplaint($clinicTitle,$st['data'],$st['files'],false);
            sendMessage($cid,$sumUser,['reply_markup'=>inlineButtons([[['text'=>'â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´','callback_data'=>'back:complaint:get_comment'],['text'=>'âœ… ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ','callback_data'=>'confirm:complaint']],[['text'=>'âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°','callback_data'=>'cancel']]])]); exit;
        }

        /* ĞĞ°Ğ·Ğ°Ğ´ */
        if(str_starts_with($data,'back:')){
            $parts=explode(':',$data); $flow=$parts[1]??''; $to=$parts[2]??'';
            if($flow==='appointment'){
                if($to==='choose_mode'){
                    $st['step']='choose_mode'; saveState($uid,$st);
                    $kb=[[['text'=>'ĞŸĞ¾ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ','callback_data'=>'apptmode:by_service'],['text'=>'ĞŸĞ¾ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚Ñƒ','callback_data'=>'apptmode:by_doctor']],[['text'=>'âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°','callback_data'=>'cancel']]];
                    sendMessage($cid,headerAppointment($st).'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ¿Ğ¾ÑĞ¾Ğ± Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸:',['reply_markup'=>inlineButtons($kb)]);
                }elseif($to==='get_name'){
                    $st['step']='get_name'; unset($st['data']['phone']); saveState($uid,$st);
                    sendMessage($cid,headerAppointment($st)."Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°ÑˆĞµ Ğ¸Ğ¼Ñ:",['reply_markup'=>kb_back_cancel('appointment','get_name')]);
                }elseif($to==='get_phone'){
                    $st['step']='get_phone'; unset($st['data']['date']); saveState($uid,$st);
                    sharePhoneAsk($cid,'appointment');
                }elseif($to==='get_date'){
                    $st['step']='get_date'; unset($st['data']['date']); saveState($uid,$st);
                    sendCalendarAsk($cid,$st);
                }elseif($to==='get_comment'){
                    $st['step']='get_comment'; saveState($uid,$st);
                    sendMessage($cid,headerAppointment($st)."Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹ (Ğ¸Ğ»Ğ¸ Â«-Â»):",['reply_markup'=>kb_back_cancel('appointment','get_comment')]);
                }elseif($to==='get_contact_method'){
                    $st['step']='get_comment'; saveState($uid,$st);
                    // Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ÑÑ Ğº ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ñ
                    sendMessage($cid,headerAppointment($st)."Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹ (Ğ¸Ğ»Ğ¸ Â«-Â»):",['reply_markup'=>kb_back_cancel('appointment','get_comment')]);
                }
            }elseif($flow==='deduction'){
                if($to==='get_name'){
                    $st['step']='get_name'; $st['data']=[]; saveState($uid,$st);
                    sendMessage($cid,headerDeduction($st)."Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°ÑˆĞµ Ğ¸Ğ¼Ñ:",['reply_markup'=>kb_back_cancel('deduction','get_name')]);
                }elseif($to==='get_phone'){
                    $st['step']='get_phone'; unset($st['data']['email']); saveState($uid,$st);
                    sharePhoneAsk($cid,'deduction');
                }
            }elseif($flow==='complaint'){
                if($to==='get_name'){
                    $st['step']='get_name'; $st['files']=[]; $st['data']=[]; saveState($uid,$st);
                    sendMessage($cid,headerComplaint($st)."Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°ÑˆĞµ Ğ¸Ğ¼Ñ:",['reply_markup'=>kb_back_cancel('complaint','get_name')]);
                }elseif($to==='get_phone'){
                    $st['step']='get_phone'; unset($st['data']['visit_date']); saveState($uid,$st);
                    sharePhoneAsk($cid,'complaint');
                }elseif($to==='get_visit_date'){
                    $st['step']='get_visit_date'; saveState($uid,$st);
                    sendMessage($cid,headerComplaint($st).'Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñƒ Ğ²Ğ¸Ğ·Ğ¸Ñ‚Ğ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, 19.11.2025):',['reply_markup'=>kb_back_cancel('complaint','get_visit_date')]);
                }elseif($to==='get_comment'){
                    $st['step']='get_comment'; saveState($uid,$st);
                    sendMessage($cid,headerComplaint($st).'ĞĞ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ñ.',['reply_markup'=>kb_back_cancel('complaint','get_comment')]);
                }
            }
            exit;
        }

    } catch (\Throwable $e) {
        elog("CB error: ".$e->getMessage());
        sendMessage($cid, "âš ï¸ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°. ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ· /start");
    }
    exit;
}

/* ====== MESSAGES ====== */
function sharePhoneAsk(int|string $cid,string $flow):void{
    // Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Â«ĞŸĞ¾Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒÑÑ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ¼Â», Ğ±ĞµĞ· Â«ÑĞ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ĞºĞ»Ğ¸Ğ½Ğ¸ĞºÑƒÂ»
    tg('sendMessage',[
        'chat_id'=>$cid,
        'text'=>'ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ° Ğ¸Ğ»Ğ¸ Ğ¿Ğ¾Ğ´ĞµĞ»Ğ¸Ñ‚ĞµÑÑŒ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ¼:',
        'reply_markup'=>json_encode([
            'keyboard'=>[[['text'=>'ğŸ“± ĞŸĞ¾Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒÑÑ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ¼','request_contact'=>true]]],
            'resize_keyboard'=>true
        ])
    ]);
    tg('sendMessage',['chat_id'=>$cid,'text'=>'','reply_markup'=>kb_back_cancel($flow,'get_phone')]);
}
function sendCalendarAsk(int|string $cid, array $st):void{
    $cal=new \Klever\Calendar(); [$markup]=$cal->render((int)date('Y'),(int)date('n'));
    tg('sendMessage',['chat_id'=>$cid,'text'=>headerAppointment($st).'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñƒ Ğ²Ğ¸Ğ·Ğ¸Ñ‚Ğ°:','parse_mode'=>'HTML','reply_markup'=>$markup]);
}

if($msg){
    $cid=$msg['chat']['id']; $uid=$msg['from']['id']; $fromU=$msg['from'];
    $text=trim((string)($msg['text']??'')); $st=loadState($uid); $cl=clinics();

    /* ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚ (Ğ¿Ğ¾ÑĞ»Ğµ ÑˆĞ°Ñ€Ğ¸Ğ½Ğ³Ğ° â€” ÑÑ€Ğ°Ğ·Ñƒ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğ¿Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ½ÑƒÑ 2Ã—2 ĞºĞ»Ğ°Ğ²Ñƒ) */
    if(isset($msg['contact']) && $st['flow'] && $st['step']==='get_phone'){
        $phone=$msg['contact']['phone_number']??'';
        $st['data']['phone']=$phone;

        // Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½ÑƒÑ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ
        restoreMainKeyboard($cid);

        if($st['flow']==='appointment'){ $st['step']='get_date'; saveState($uid,$st); sendCalendarAsk($cid,$st); exit; }
        if($st['flow']==='deduction'){ $st['step']='get_email'; saveState($uid,$st); sendMessage($cid,headerDeduction($st).'Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°ÑˆÑƒ ÑĞ»ĞµĞºÑ‚Ñ€Ğ¾Ğ½Ğ½ÑƒÑ Ğ¿Ğ¾Ñ‡Ñ‚Ñƒ:',['reply_markup'=>kb_back_cancel('deduction','get_phone')]); exit; }
        if($st['flow']==='complaint'){ $st['step']='get_visit_date'; saveState($uid,$st); sendMessage($cid,headerComplaint($st).'Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñƒ Ğ²Ğ¸Ğ·Ğ¸Ñ‚Ğ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, 19.11.2025):',['reply_markup'=>kb_back_cancel('complaint','get_visit_date')]); exit; }
    }

    /* Ğ’Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¶Ğ°Ğ»Ğ¾Ğ±Ñ‹ */
    if((isset($msg['photo'])||isset($msg['document'])||isset($msg['video'])) && $st['flow']==='complaint'){
        if(isset($msg['photo'])){ $ph=end($msg['photo']); $fid=$ph['file_id']; $link=getFileLink($fid); $st['files'][]=['type'=>'photo','file_id'=>$fid,'link'=>$link]; }
        if(isset($msg['document'])){ $fid=$msg['document']['file_id']; $link=getFileLink($fid); $st['files'][]=['type'=>'document','file_id'=>$fid,'link'=>$link]; }
        if(isset($msg['video'])){ $fid=$msg['video']['file_id']; $link=getFileLink($fid); $st['files'][]=['type'=>'video','file_id'=>$fid,'link'=>$link]; }
        saveState($uid,$st);
        sendMessage($cid,headerComplaint($st)."ğŸ“ Ğ¤Ğ°Ğ¹Ğ» Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½. ĞœĞ¾Ğ¶ĞµÑ‚Ğµ Ğ¿Ñ€Ğ¸ĞºÑ€ĞµĞ¿Ğ¸Ñ‚ÑŒ ĞµÑ‰Ñ‘ Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Â«ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒÂ».",
            ['reply_markup'=>inlineButtons([[['text'=>'â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´','callback_data'=>'back:complaint:get_comment'],['text'=>'âœ… ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ','callback_data'=>'confirm:complaint']],[['text'=>'âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°','callback_data'=>'cancel']]])]); exit;
    }

    /* ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº (/start â€” Ğ² ĞºĞ¾Ğ½Ñ†Ğµ ÑĞ¿Ğ¸ÑĞºĞ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´) */
    if($text==='/start'){ $st=fullReset($uid); askClinic($cid); exit; }

    /* Ğ¡Ğ¿Ñ€Ğ°Ğ²ĞºĞ° (Ñ‡ĞµĞ»Ğ¾Ğ²ĞµÑ‡Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚) */
    if($text==='â„¹ï¸ Ğ¡Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¿Ğ¾ Ğ±Ğ¾Ñ‚Ñƒ' || $text==='/help'){
        sendMessage($cid,"Ğ¯ Ñ‡Ğ°Ñ‚-Ğ±Ğ¾Ñ‚ Ñ†ĞµĞ½Ñ‚Ñ€Ğ° Â«ĞšĞ»ĞµĞ²ĞµÑ€Â». ĞŸĞ¾Ğ¼Ğ¾Ğ³Ğ°Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾:\nâ€¢ Ğ·Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒÑÑ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ‘Ğ¼ Ğº ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚Ğ°Ğ¼,\nâ€¢ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚ÑŒ Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ Ğ²Ñ‹Ñ‡ĞµÑ‚ Ğ·Ğ° Ğ»ĞµÑ‡ĞµĞ½Ğ¸Ğµ,\nâ€¢ Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚Ğ·Ñ‹Ğ² Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¶Ğ°Ğ»Ğ¾Ğ±Ñƒ Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»Ñ,\nâ€¢ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ Ğ¸ ÑĞ¿Ñ€Ğ°Ğ²Ğ¾Ñ‡Ğ½ÑƒÑ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ.\n\nĞ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:\n/appointment â€” Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ‘Ğ¼\n/deduction â€” ĞĞ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ Ğ²Ñ‹Ñ‡ĞµÑ‚\n/feedback â€” ĞÑ‚Ğ·Ñ‹Ğ²\n/complaint â€” Ğ–Ğ°Ğ»Ğ¾Ğ±Ğ°\n/start â€” ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº");
        exit;
    }

    /* ĞÑ‚Ğ·Ñ‹Ğ² */
    if($text==='/feedback' || $text==='â­ ĞÑ‚Ğ·Ñ‹Ğ²'){
        $row=[[['text'=>'ğŸ’š ĞĞµĞ²Ñ€Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ','url'=>'https://2gis.ru/khabarovsk/firm/4926340373508276/135.066627%2C48.507797/tab/reviews?m=135.066632%2C48.507778%2F18.68'],['text'=>'ğŸ§© Ğ¦ĞµĞ½Ñ‚Ñ€ Ñ€Ğ°Ğ·Ğ²Ğ¸Ñ‚Ğ¸Ñ Ñ€ĞµÑ‡Ğ¸','url'=>'https://2gis.ru/khabarovsk/firm/70000001029431055/135.088006%2C48.490784/tab/reviews?m=135.087791%2C48.490347%2F17.88']]];
        sendMessage($cid,'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿Ğ»Ğ¾Ñ‰Ğ°Ğ´ĞºÑƒ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ°:',['reply_markup'=>inlineButtons($row)]); exit;
    }

    /* Ğ¢Ğ¾Ñ‡ĞºĞ¸ Ğ²Ñ…Ğ¾Ğ´Ğ° */
    if($text==='/appointment' || $text==='ğŸ—“ Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ğ½Ğ° Ğ¿Ñ€Ğ¸Ñ‘Ğ¼'){
        if(!$st['clinic']){ askClinic($cid); exit; }
        $st['flow']='appointment'; $st['step']='choose_mode'; $st['data']=[]; $st['files']=[]; saveState($uid,$st);
        $kb=[[['text'=>'ĞŸĞ¾ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ','callback_data'=>'apptmode:by_service'],['text'=>'ĞŸĞ¾ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚Ñƒ','callback_data'=>'apptmode:by_doctor']],[['text'=>'âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°','callback_data'=>'cancel']]];
        sendMessage($cid,headerAppointment($st).'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ¿Ğ¾ÑĞ¾Ğ± Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸:',['reply_markup'=>inlineButtons($kb)]); exit;
    }
    if($text==='/deduction' || $text==='ğŸ’° ĞĞ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğ¹ Ğ²Ñ‹Ñ‡ĞµÑ‚'){
        if(!$st['clinic']){ askClinic($cid); exit; }
        if($st['clinic']!=='neuro'){
            $kb=[[['text'=>'ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ Ğ½Ğ° Ğ¦ĞµĞ½Ñ‚Ñ€ Ğ½ĞµĞ²Ñ€Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ğ¸','callback_data'=>'clinic:neuro']],[['text'=>'âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°','callback_data'=>'cancel']]];
            sendMessage($cid,headerDeduction($st).'Ğ­Ñ‚Ğ° Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² Ğ¦ĞµĞ½Ñ‚Ñ€Ğµ Ğ½ĞµĞ²Ñ€Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ğ¸ Â«ĞšĞ»ĞµĞ²ĞµÑ€Â». Ğ¥Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ?',['reply_markup'=>inlineButtons($kb)]); exit;
        }
        $st=['step'=>'get_name','flow'=>'deduction','clinic'=>$st['clinic'],'data'=>[],'files'=>[]]; saveState($uid,$st);
        sendMessage($cid,headerDeduction($st)."Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°ÑˆĞµ Ğ¸Ğ¼Ñ:",['reply_markup'=>kb_back_cancel('deduction','get_name')]); exit;
    }
    if($text==='/complaint' || $text==='âš ï¸ Ğ–Ğ°Ğ»Ğ¾Ğ±Ğ° Ñ€ÑƒĞºĞ¾Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»Ñ'){
        if(!$st['clinic']){ askClinic($cid); exit; }
        $st=['step'=>'get_name','flow'=>'complaint','clinic'=>$st['clinic'],'data'=>[],'files'=>[]]; saveState($uid,$st);
        sendMessage($cid,headerComplaint($st)."Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°ÑˆĞµ Ğ¸Ğ¼Ñ:",['reply_markup'=>kb_back_cancel('complaint','get_name')]); exit;
    }
    if($text==='ğŸ“ ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹'){
        if(!$st['clinic']){ askClinic($cid); exit; }
        $cAll=contactsByClinic($st['clinic']); $c=$cAll[$st['clinic']];
        sendMessage($cid,formatContacts($c)); exit;
    }
    if($text==='ğŸ”„ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ĞºĞ»Ğ¸Ğ½Ğ¸ĞºÑƒ'){ $st=fullReset($uid); askClinic($cid); exit; }

    /* ĞŸĞ¾Ñ‚Ğ¾ĞºĞ¸ */
    if(!$st['clinic']){ askClinic($cid); exit; }

    // appointment
    if($st['flow']==='appointment'){
        if($st['step']==='choose_mode'){
            $kb=[[['text'=>'ĞŸĞ¾ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ','callback_data'=>'apptmode:by_service'],['text'=>'ĞŸĞ¾ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸ÑÑ‚Ñƒ','callback_data'=>'apptmode:by_doctor']],[['text'=>'âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°','callback_data'=>'cancel']]];
            sendMessage($cid,headerAppointment($st).'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ¿Ğ¾ÑĞ¾Ğ± Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸:',['reply_markup'=>inlineButtons($kb)]); exit;
        }
        if($st['step']==='get_name'){
            if($text===''){ sendMessage($cid,headerAppointment($st).'Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ:',['reply_markup'=>kb_back_cancel('appointment','get_name')]); exit; }
            $st['data']['name']=$text; $st['step']='get_phone'; saveState($uid,$st);
            sharePhoneAsk($cid,'appointment'); exit;
        }
        if($st['step']==='get_phone'){
            if(!preg_match('~\+?\d{10,15}~',$text)){ sendMessage($cid,headerAppointment($st).'Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ +7XXXXXXXXXX:',['reply_markup'=>kb_back_cancel('appointment','get_phone')]); exit; }
            $st['data']['phone']=$text; $st['step']='get_date'; saveState($uid,$st);
            sendCalendarAsk($cid,$st); exit;
        }
        if($st['step']==='get_comment'){
            $st['data']['comment']=($text==='-'?'':$text);
            $st['step']='get_contact_method'; saveState($uid,$st);
            $kb = [
                [['text'=>'ğŸ“ ĞŸĞµÑ€ĞµĞ·Ğ²Ğ¾Ğ½Ğ¸Ñ‚ÑŒ','callback_data'=>'contact_method:call']],
                [['text'=>'ğŸ’¬ ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ² WhatsApp','callback_data'=>'contact_method:whatsapp']],
                [['text'=>'ğŸ’¬ ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ² Telegram','callback_data'=>'contact_method:telegram']],
                [['text'=>'â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´','callback_data'=>'back:appointment:get_contact_method'],['text'=>'âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°','callback_data'=>'cancel']],
            ];
            sendMessage($cid,headerAppointment($st)."Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑƒĞ´Ğ¾Ğ±Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¾ÑĞ¾Ğ± ÑĞ²ÑĞ·Ğ¸:",['reply_markup'=>inlineButtons($kb)]);
            exit;
        }
        if($st['step']==='confirm'){
            // Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°: ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ñ€Ğ¸ÑĞ»Ğ°Ğ» Ñ‚ĞµĞºÑÑ‚ Ğ½Ğ° ÑÑ‚Ğ°Ğ¿Ğµ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ â€” Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ğ¾ĞºĞ°Ğ¶ĞµĞ¼ Ñ€ĞµĞ·ÑĞ¼Ğµ Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸
            $clinicTitle=clinics()[$st['clinic']]['title']; $sumUser=summarizeAppointment($clinicTitle,$st['data'],false);
            $kb=[[['text'=>'â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´','callback_data'=>'back:appointment:get_contact_method'],['text'=>'âœ… ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ','callback_data'=>'confirm:appointment']],[['text'=>'âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°','callback_data'=>'cancel']]];
            sendMessage($cid,$sumUser,['reply_markup'=>inlineButtons($kb)]); exit;
        }
    }

    // deduction
    if($st['flow']==='deduction'){
        if($st['step']==='get_name'){
            if($text===''){ sendMessage($cid,headerDeduction($st).'Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ:',['reply_markup'=>kb_back_cancel('deduction','get_name')]); exit; }
            $st['data']['name']=$text; $st['step']='get_phone'; saveState($uid,$st);
            sharePhoneAsk($cid,'deduction'); exit;
        }
        if($st['step']==='get_phone'){
            if(!preg_match('~\+?\d{10,15}~',$text)){ sendMessage($cid,headerDeduction($st).'Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ +7XXXXXXXXXX:',['reply_markup'=>kb_back_cancel('deduction','get_phone')]); exit; }
            $st['data']['phone']=$text; $st['step']='get_email'; saveState($uid,$st);
            sendMessage($cid,headerDeduction($st).'Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°ÑˆÑƒ ÑĞ»ĞµĞºÑ‚Ñ€Ğ¾Ğ½Ğ½ÑƒÑ Ğ¿Ğ¾Ñ‡Ñ‚Ñƒ:',['reply_markup'=>kb_back_cancel('deduction','get_phone')]); exit;
        }
        if($st['step']==='get_email'){
            if(!filter_var($text,FILTER_VALIDATE_EMAIL)){ sendMessage($cid,headerDeduction($st).'Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ e-mail:',['reply_markup'=>kb_back_cancel('deduction','get_phone')]); exit; }
            $st['data']['email']=$text; $st['step']='confirm'; saveState($uid,$st);
            $clinicTitle=clinics()[$st['clinic']]['title']; $sumUser=summarizeDeduction($clinicTitle,$st['data'],false);
            $kb=[[['text'=>'â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´','callback_data'=>'back:deduction:get_phone'],['text'=>'âœ… ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ','callback_data'=>'confirm:deduction']],[['text'=>'âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°','callback_data'=>'cancel']]];
            sendMessage($cid,$sumUser,['reply_markup'=>inlineButtons($kb)]); exit;
        }
    }

    // complaint
    if($st['flow']==='complaint'){
        if($st['step']==='get_name'){
            if($text===''){ sendMessage($cid,headerComplaint($st).'Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ:',['reply_markup'=>kb_back_cancel('complaint','get_name')]); exit; }
            $st['data']['name']=$text; $st['step']='get_phone'; saveState($uid,$st);
            sharePhoneAsk($cid,'complaint'); exit;
        }
        if($st['step']==='get_phone'){
            if(!preg_match('~\+?\d{10,15}~',$text)){ sendMessage($cid,headerComplaint($st).'Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ +7XXXXXXXXXX:',['reply_markup'=>kb_back_cancel('complaint','get_phone')]); exit; }
            $st['data']['phone']=$text; $st['step']='get_visit_date'; saveState($uid,$st);
            sendMessage($cid,headerComplaint($st).'Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñƒ Ğ²Ğ¸Ğ·Ğ¸Ñ‚Ğ° (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, 19.11.2025):',['reply_markup'=>kb_back_cancel('complaint','get_visit_date')]); exit;
        }
        if($st['step']==='get_visit_date'){
            $iso=parseDmyToIso($text); if(!$iso){ sendMessage($cid,headerComplaint($st).'Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ´Ğ°Ñ‚Ñƒ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ Ğ´Ğ´.Ğ¼Ğ¼.Ğ³Ğ³Ğ³Ğ³:',['reply_markup'=>kb_back_cancel('complaint','get_visit_date')]); exit; }
            $st['data']['visit_date']=$iso; $st['step']='get_comment'; saveState($uid,$st);
            sendMessage($cid,headerComplaint($st).'ĞĞ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ ÑĞ¸Ñ‚ÑƒĞ°Ñ†Ğ¸Ñ.',['reply_markup'=>kb_back_cancel('complaint','get_comment')]); exit;
        }
        if($st['step']==='get_comment'){
            $st['data']['comment']=$text; $st['step']='attach_choice'; saveState($uid,$st);
            sendMessage($cid,headerComplaint($st).'Ğ¥Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¸ĞºÑ€ĞµĞ¿Ğ¸Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ»Ñ‹?',['reply_markup'=>inlineButtons([[['text'=>'Ğ”Ğ°','callback_data'=>'attach_yes'],['text'=>'ĞĞµÑ‚','callback_data'=>'attach_no']],[['text'=>'â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´','callback_data'=>'back:complaint#get_comment'],['text'=>'âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°','callback_data'=>'cancel']]])]); exit;
        }
        if($st['step']==='attach_files'){
            sendMessage($cid,headerComplaint($st).'ĞŸÑ€Ğ¸ÑˆĞ»Ğ¸Ñ‚Ğµ Ñ„Ğ¾Ñ‚Ğ¾/Ğ²Ğ¸Ğ´ĞµĞ¾/Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ‹.',['reply_markup'=>inlineButtons([[['text'=>'â¬…ï¸ ĞĞ°Ğ·Ğ°Ğ´','callback_data'=>'back:complaint:get_comment'],['text'=>'âœ… ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ','callback_data'=>'confirm:complaint']],[['text'=>'âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ°','callback_data'=>'cancel']]])]); exit;
        }
    }

    if($st['clinic']&&isset($cl[$st['clinic']])) sendKeyboardMain($cid,$cl[$st['clinic']]['title']); else askClinic($cid);
    exit;
}

http_response_code(200);
